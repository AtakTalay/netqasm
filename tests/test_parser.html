<p>import pytest</p>
<h1>from netqasm.parser import Parser, Subroutine, Command, Address, AddressMode, QubitAddress, Array</h1>
<p>from netqasm.subroutine import (
    Constant,
    Label,
    RegisterName,
    Register,
    MemoryAddress,
    Command,
    BranchLabel,
    Subroutine,
)
from netqasm.parser import parse_subroutine
from netqasm.util import NetQASMInstrError, NetQASMSyntaxError</p>
<p>@pytest.mark.parametrize("subroutine, error", [
    ("# WRONG", NetQASMInstrError),  # Wrong keyword
    ("# APPID 0\nH 0\n#APPID 0", NetQASMSyntaxError),  # Preamble after body
    ("# DEFINE args {0, 0", NetQASMSyntaxError),  # No end-bracket
    ("# NETQASM", NetQASMSyntaxError),  # No argument
    ("# NETQASM 1 2", NetQASMSyntaxError),  # Two arguments
    ("# APPID", NetQASMSyntaxError),  # No argument
    ("# APPID 1 2", NetQASMSyntaxError),  # Two arguments
    ("# DEFINE args", NetQASMSyntaxError),  # One arguments
    ("# DEFINE args 0 0", NetQASMSyntaxError),  # Three arguments
    ("# DEFINE 1args 0", NetQASMInstrError),  # Not a valid macro key
    ("# DEFINE args 0\n# DEFINE args 1", NetQASMInstrError),  # Not unique macro keys
])
def test_faulty_preamble(subroutine, error):
    with pytest.raises(error):
        parse_subroutine(subroutine)</p>
<p>def test_simple():
    subroutine = """</p>
<h1>NETQASM 0.0</h1>
<h1>APPID 0</h1>
<p>set R0 0
store 1 @0
store 1 @R0
store R0 @1
store R0 @R0
store R0 @0[0]
store R0 @R0[R1]
"""
    """
set Q0 0
init Q0
init Q0
array(4) @2
add R1 R2 1
beq 0 0 EXIT
EXIT:
"""</p>
<pre><code>expected = Subroutine(
    netqasm_version="0.0",
    app_id=0,
    commands=[
        Command(instruction="set", args=[], operands=[
            Register(RegisterName.R, Constant(0)),
            Constant(0),
        ]),
        Command(instruction="store", args=[], operands=[
            Constant(1),
            MemoryAddress(
                base_address=Constant(0),
                index=None,
            ),
        ]),
        Command(instruction="store", args=[], operands=[
            Constant(1),
            MemoryAddress(
                base_address=Register(RegisterName.R, Constant(0)),
                index=None,
            ),
        ]),
        Command(instruction="store", args=[], operands=[
            Register(RegisterName.R, Constant(0)),
            MemoryAddress(
                base_address=Constant(1),
                index=None,
            ),
        ]),
        Command(instruction="store", args=[], operands=[
            Register(RegisterName.R, Constant(0)),
            MemoryAddress(
                base_address=Register(RegisterName.R, Constant(0)),
                index=None,
            ),
        ]),
        Command(instruction="store", args=[], operands=[
            Register(RegisterName.R, Constant(0)),
            MemoryAddress(
                base_address=Constant(1),
                index=Constant(0),
            ),
        ]),
        Command(instruction="store", args=[], operands=[
            Register(RegisterName.R, Constant(0)),
            MemoryAddress(
                base_address=Register(RegisterName.R, Constant(0)),
                index=Register(RegisterName.R, Constant(1)),
            ),
        ]),
    ])

subroutine = parse_subroutine(subroutine)
for i, command in enumerate(subroutine.commands):
    exp_command = expected.commands[i]
    print(command)
    print(exp_command)
    assert command == exp_command
print(repr(subroutine))
print(repr(expected))
assert subroutine == expected
</code></pre>
<p>def test_loop():
    subroutine = """</p>
<h1>NETQASM 0.0</h1>
<h1>APPID 0</h1>
<h1>DEFINE ms @0</h1>
<p>// Setup classical registers
set Q0 0
array(10) ms!
set R0 0</p>
<p>// Loop entry
LOOP:
beq R0 10 EXIT</p>
<p>// Loop body
qalloc Q0
init Q0
h Q0
meas Q0 M0</p>
<p>// Store to array
store M0 ms![R0]</p>
<p>qfree Q0
add R0 R0 1</p>
<p>// Loop exit
beq 0 0 LOOP
EXIT:
"""
    subroutine = parse_subroutine(subroutine)
    print(subroutine)</p>
<p>def test_teleport():
    subroutine = """</p>
<h1>NETQASM 0.0</h1>
<h1>APPID 0</h1>
<p>array(1) epr_address
store epr_address[0] 1
array(1) entinfo
qalloc q
h q
create_epr epr_address entinfo
wait entinfo
cnot q <em>epr_address[0]
h q
meas q m1
meas </em>epr_address[0] m2
"""</p>
<pre><code>parser = Parser(subroutine)
print(parser)
</code></pre>
<p>if <strong>name</strong> == "<strong>main</strong>":
    test_simple()
    # test_loop()
    # test_teleport()</p>